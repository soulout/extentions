Okta.WebExtension=function(r,s,o,n){var c=PLUGIN_VERSIONS.currentVersion;var e=_okta.delay,a={},t=_okta.extend,i=_okta.each,u=_okta.filter,f=_okta.find,l=_okta.where,d=Okta.Q.defer,g=Okta.Events,m=Okta.fn.base.curry2,p=Okta.fn.base.always,b=Okta.fn.url.getMonitoredSitesApiMatchPatterns,h=Okta.fn.url.isOktaEndUserHomeHref,k=Okta.fn.bg.findAuthSite,v=Okta.fn.bg.getLastAuthTimestamp,L=Okta.fn.bg.setLastAuthTimestamp,x=Okta.fn.bg.getBasicAuthCreds,I=Okta.fn.bg.getPendingConsentAccount,O=Okta.Url,w="shared/shared.js",S=n==="firefox",y=n==="edge",E=new Okta.AuthenticationMonitor(r,s,o,n),T=t({},g),q=1e3,R;if(typeof Okta.WebExtensionExecuteScript==="function"){R=Okta.WebExtensionExecuteScript()}else{R=function(){Log.error("Failed to find executeScript")}}var j=2*1e3,A=1e3;function U(n){var o=d();chrome.tabs.query({},function e(t){var r=l(t,{id:n}).length>0;if(r){chrome.tabs.get(n,function e(t){o.resolve(t)})}else{o.resolve(null)}});return o.promise}function C(e){return/^http/.test(e)}function H(){var r=(new Date).getTime();i(Object.keys(a),function(e){var t=a[e];if(t.timeStamp+q>r){return}console.log("Injecting script. Tab id: "+t.tabId);T.trigger("injectReady",{tabId:t.id,frameId:t.frameId});delete a[e]});if(Object.keys(a).length){setTimeout(H,q)}}function W(r){if(!C(r.url)){console.log("Skipped url: "+r.url);return}U(r.tabId).then(function e(t){if(!t||!C(t.url)){return}if(r.frameId){if(!Object.keys(a).length){setTimeout(H,q)}a[r.tabId]={tabId:r.tabId,frameId:r.frameId,timeStamp:r.timeStamp};console.log("Tabs: "+JSON.stringify(a));return}T.trigger("injectReady",{tabId:t.id,frameId:r.frameId})})}function _(e,t){T.trigger("messageFromContent",{msg:t,tabId:e.sender&&e.sender.tab?e.sender.tab.id:-1,portInfo:{port:e}})}function B(e){var t="X-Okta-User-Agent-Extended",r="okta-browser-plugin/"+c,n={requestHeaders:[]},o="X-Okta-User-Agent-Account-Data";if(e.requestHeaders){n.requestHeaders=e.requestHeaders}try{if(h&&h(e.url)){var a=f(n.requestHeaders,function(e){return e.name.toLowerCase()===t.toLowerCase()});var i=I?I(s):"";if(a){a.value+=" "+r}else{n.requestHeaders.push({name:t,value:r});n.requestHeaders.push({name:o,value:i})}}}catch(e){Log.error("WebExtension::onBeforeSendHeaders Error: "+e.message)}return n}function M(e,t){if(t){Log.info("WebExtension::injectScript: Injecting content script from "+"persistent");R(e.tabId,t)}else{Log.info("WebExtension::injectScript: Injecting content script from "+"file");var r=new XMLHttpRequest;r.open("GET",chrome.extension.getURL(w),true);r.overrideMimeType("text/plain");r.onload=function(){R(e.tabId,r.responseText)};r.onerror=function(){Log.error("WebExtension::injectScript: Failed to load file: "+w)};r.send()}}function P(e){var n,t;n=k(s,new O(e.url));if(!n||!n.credURI){return Promise.reject()}t=v(r,n.authURL);if(e.timeStamp-t<j){return Promise.reject()}L(r,n.authURL,e.timeStamp);return new Promise(function(t,r){x(o,s,n.credURI).then(function(e){if(e&&e.u&&e.p){t({authCredentials:{username:e.u,password:e.p}})}else{r()}}).fail(r)})}function N(e,t){P(e).then(function(e){t(e)}).catch(function(){t()})}function D(){e(function(){E.initialize()},A)}T.getType=p(n);T.getBackgroundVersion=p(c);T.post=function e(t){t.portInfo.port.postMessage(t.msg)};T.injectScript=function(e,t){M(e,t)};T.openTab=function(e){if(!e){return}switch(n){case"chrome":chrome.tabs.create({url:e});break;case"edge":chrome.tabs.create({url:e.split("?")[0]});break;case"firefox":chrome.tabs.create({url:e});var t=chrome.extension.getViews({type:"popup"});if(t.length!=1){Log.warn("WebExtension::openTab: "+"Did not close popup. Windows count: "+t.length);return}t[0].close();break;default:Log.error("WebExtension::openTab: Unknown browser type!")}};T.openTabForAccountChooser=function(r){if(r){chrome.tabs.query({active:true},function(e){if(e&&e.length>0){var t=e[0];if(t.url.indexOf(r)>-1){if(y){T.openTab(r);T.closeTab(t.id)}else{chrome.tabs.reload()}}else{chrome.tabs.create({url:r})}}else{chrome.tabs.create({url:r})}})}};T.servePopover=function(){console.log("serve popover");chrome.tabs.update({url:chrome.runtime.getURL("shared/popover/popover.html")})};T.closeTab=function(e){if(e){chrome.tabs.remove(e)}};T.getCookies=function(e,r){var n=d();chrome.cookies.getAll({url:e},function(e){var t=u(e,function(e){return r.indexOf(e.name)>-1});n.resolve(t)});return n.promise};T.updateBadge=function(e){if(e){chrome.browserAction.setBadgeText({text:e.text});if(e.color!==""){chrome.browserAction.setBadgeBackgroundColor({color:e.color})}}};T.getLocalStorageUsage=function(){var t=d(),e=0;try{for(var r=0;r<localStorage.length;++r){e+=localStorage.getItem(localStorage.key(r)).length}Log.info("WebExtension::getLocalStorageUsage: {0} bytes used",e);t.resolve(e)}catch(e){Log.error("WebExtension::getLocalStorageUsage Error: {0}",e);t.reject(e)}return t.promise};var F=m(_),V=chrome.runtime.onConnect,X=chrome.webRequest.onCompleted,z=chrome.webNavigation.onTabReplaced,G={urls:["<all_urls>"]},J=N,Q=["asyncBlocking"];if(S){z=null;J=P;Q=["blocking"]}if(y){G.types=["main_frame","sub_frame"];X=chrome.webNavigation.onCompleted}chrome.webNavigation.onDOMContentLoaded.addListener(W);if(z){z.addListener(W)}chrome.webRequest.onBeforeSendHeaders.addListener(B,G,["requestHeaders","blocking"]);V.addListener(function e(t){t.onMessage.addListener(F(t))});chrome.webRequest.onAuthRequired&&chrome.webRequest.onAuthRequired.addListener(J,{urls:["<all_urls>"]},Q);X&&X.addListener(D,{urls:b(),types:["xmlhttprequest"]});E.initialize(false);return T};