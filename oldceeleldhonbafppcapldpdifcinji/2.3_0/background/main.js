/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
function isPageLoadedMessage(e){return"PAGE_LOADED"===e.command}function isExtensionStatusChangedMessage(e){return"EXTENSION_STATUS_CHANGED"===e.command}function isTrackTextLength(e){return"TRACK_TEXT_LENGTH"===e.command}function isTrackEventMessage(e){return"TRACK_EVENT"===e.command}function isShowTurnOnHintMessage(e){return"SHOW_TURN_ON_HINT"===e.command}function isOpenFeedbackForm(e){return"OPEN_FEEDBACK_FORM"===e.command}function isSendFeedbackMessage(e){return"SEND_FEEDBACK"===e.command}function isOpenOptionsMessage(e){return"OPEN_OPTIONS"===e.command}function isOpenPrivacyConfirmationMessage(e){return"OPEN_PRIVACY_CONFIRMATION"===e.command}function isCloseCurrentTabMessage(e){return"CLOSE_CURRENT_TAB"===e.command}function isValidateTextMessage(e){return"VALIDATE_TEXT"===e.command}function isLaunchValidatorMessage(e){return"LAUNCH_VALIDATOR"===e.command}function isValidatorLoadedMessage(e){return"VALIDATOR_LOADED"===e.command}class BackgroundApp{static _constructor(){BackgroundApp._isInitialized||(BackgroundApp._onDataLoaded=BackgroundApp._onDataLoaded.bind(BackgroundApp),BackgroundApp._onInstalled=BackgroundApp._onInstalled.bind(BackgroundApp),BackgroundApp._onMessage=BackgroundApp._onMessage.bind(BackgroundApp),BackgroundApp._onValidateClicked=BackgroundApp._onValidateClicked.bind(BackgroundApp),BackgroundApp._storageController=new StorageController(BackgroundApp._onDataLoaded),browser.runtime.onInstalled.addListener(BackgroundApp._onInstalled),browser.runtime.onMessage.addListener(BackgroundApp._onMessage),browser.contextMenus&&browser.contextMenus.create({title:browser.i18n.getMessage("contextMenuValidate"),contexts:["selection"],onclick:BackgroundApp._onValidateClicked}),this._isInitialized=!0)}static _assignToTestGroups(){if(!isProductionEnvironment())return;const{frenchPremiumRules:e}=this._storageController.getTestFlags();e||this._storageController.updateTestFlags({frenchPremiumRules:Math.random()<.5?"test":"control"})}static _updateBadge(e,a){browser.browserAction.setBadgeTextColor&&browser.browserAction.setBadgeTextColor({tabId:e,color:"#FFFFFF"}),a.enabled&&a.supported?a.capitalization?browser.browserAction.setBadgeText({tabId:e,text:""}):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#45A8FC"}),browser.browserAction.setBadgeText({tabId:e,text:BrowserDetector.isOpera()?"":"abc"})):(browser.browserAction.setBadgeBackgroundColor({tabId:e,color:"#F53987"}),browser.browserAction.setBadgeText({tabId:e,text:BrowserDetector.isOpera()?"":"OFF"}))}static _updateUninstallURL(e="unknown"){const a=BackgroundApp._storageController.getSettings(),t=BackgroundApp._storageController.getPrivacySettings(),n=BackgroundApp._storageController.getStatistics(),o=BackgroundApp._storageController.getTestFlags(),r=browser.runtime.getManifest(),s=r&&r.version||"unknown";e=e.slice(0,25);let i=`${config.UNINSTALL_URL}?autoCheck=${a.autoCheck}`;i+=`&host=${encodeURIComponent(e)}&v=${s}&privacyConfirmed=${t.allowRemoteCheck}`,i+=`&usages=${n.usageCount}&sessions=${n.sessionCount}`;const g=BackgroundApp._storageController.getUniqueId();g&&(i+=`&matomo=${g}`);for(const e in o)o.hasOwnProperty(e)&&(i+=`&${e}=${o[e]}`);isProductionEnvironment()||(i+="&dev"),i=i.slice(0,255),browser.runtime.setUninstallURL(i)}static _setMotherTongue(){BackgroundApp._storageController.onReady(()=>{const{motherTongue:e,geoIpLanguages:a}=BackgroundApp._storageController.getSettings();if(e)return;const t=a.some(e=>!!e.match(/^de/i))&&navigator.languages[0]&&navigator.languages[0].match(/^de/i)&&browser.i18n.getUILanguage().match(/^de/i),n=Array.from(navigator.languages).some(e=>!e.match(/^(de|en)/i));t&&!n&&(Tracker.trackEvent("Action","set_mother_tongue","de"),BackgroundApp._storageController.updateSettings({motherTongue:"de"}))})}static _launchValidator(e){const a=Math.round(99999*Math.random())+":"+Date.now();BackgroundApp._validatorsData[a]={id:a,text:e,timestamp:Date.now()},browser.tabs.create({url:browser.runtime.getURL(`/validator/validator.html?id=${a}`)})}static _onDataLoaded(){BackgroundApp._storageController.checkForPaidSubscription().catch(e=>{Tracker.trackError("js",`Error checking paid subscripton: ${e&&e.message}`)}),Tracker.trackActivity(),BackgroundApp._updateUninstallURL()}static _onInstalled(e){const{reason:a,previousVersion:t}=e;BackgroundApp._storageController.onReady(()=>{if("install"===a){if(!BackgroundApp._storageController.getPrivacySettings().allowRemoteCheck&&!BackgroundApp._storageController.getUIState().hasSeenPrivacyConfirmationDialog){BackgroundApp._storageController.updateUIState({hasSeenPrivacyConfirmationDialog:!0});let e=`${config.INSTALL_URL}?new`;isProductionEnvironment()||(e+="&dev"),browser.tabs.create({url:e}),BackgroundApp._assignToTestGroups(),BackgroundApp._updateUninstallURL(),getLanguagesForGeoIPCountry().then(e=>{"US"!==e.geoIpCountry||e.geoIpLanguages.includes("es")?["MA","DZ","TN"].includes(e.geoIpCountry)&&!e.geoIpLanguages.includes("fr")&&e.geoIpLanguages.push("fr"):e.geoIpLanguages.push("es");const a={geoIpLanguages:e.geoIpLanguages,geoIpCountry:e.geoIpCountry||""};"GB"===e.geoIpCountry?a.enVariant="en-GB":"US"===e.geoIpCountry?a.enVariant="en-US":"CA"===e.geoIpCountry?a.enVariant="en-CA":"NZ"===e.geoIpCountry?a.enVariant="en-NZ":"AU"===e.geoIpCountry?a.enVariant="en-AU":"ZA"===e.geoIpCountry?a.enVariant="en-ZA":"DE"===e.geoIpCountry?a.deVariant="de-DE":"AT"===e.geoIpCountry?a.deVariant="de-AT":"CH"===e.geoIpCountry?a.deVariant="de-CH":"BR"===e.geoIpCountry?a.ptVariant="pt-BR":"PT"===e.geoIpCountry&&(a.ptVariant="pt-PT"),BackgroundApp._storageController.updateSettings(a),BackgroundApp._setMotherTongue()}).catch(e=>{Tracker.trackError("js",e&&e.message)}),Tracker.trackInstall()}}else if("update"===a){BackgroundApp._assignToTestGroups(),BackgroundApp._updateUninstallURL();const e=browser.runtime.getManifest(),a=e&&e.version||"unknown";t!==a&&Tracker.trackEvent("Action","update",String(a));const{apiServerUrl:n}=this._storageController.getSettings();"https://languagetool.org/api/v2"!==n&&"https://languagetool.org/api/v2/"!==n||(this._storageController.updateSettings({apiServerUrl:config.MAIN_SERVER_URL}),Tracker.trackEvent("Action","update:migrate_api_server_url"))}})}static _onMessage(e,a,t){let n;return isPageLoadedMessage(e)?n=BackgroundApp._onPageLoadedMessage(a,e):isExtensionStatusChangedMessage(e)?n=BackgroundApp._onExtensionStatusChangedMessage(a,e):isTrackTextLength(e)?n=BackgroundApp._onTrackTextLengthMessage(a,e):isTrackEventMessage(e)?n=BackgroundApp._onTrackEventMessage(a,e):isShowTurnOnHintMessage(e)?n=BackgroundApp._onShowTurnOnHintMessage(a,e):isOpenFeedbackForm(e)?n=BackgroundApp._onOpenFeedbackForm(a,e):isSendFeedbackMessage(e)?n=BackgroundApp._onSendFeedbackMessage(a,e):isOpenOptionsMessage(e)?n=BackgroundApp._onOpenOptionsMessage(a,e):isOpenPrivacyConfirmationMessage(e)?n=BackgroundApp._onOpenPrivacyConfirmationMessage(a,e):isCloseCurrentTabMessage(e)?n=BackgroundApp._onCloseCurrentTabMessage(a,e):isValidateTextMessage(e)?n=BackgroundApp._onValidateTextMessage(a,e):isLaunchValidatorMessage(e)?n=BackgroundApp._onLaunchValidatorMessage(a,e):isValidatorLoadedMessage(e)&&(n=BackgroundApp._onValidatorLoadedMessage(a,e)),n||Promise.resolve(null)}static _onPageLoadedMessage(e,a){if(0!==e.frameId||!e.tab)return;const t=e.tab.id,n={enabled:a.enabled,capitalization:a.capitalization,supported:a.supported,unsupportedMessage:a.unsupportedMessage,language:null};BackgroundApp._extensionStates[t]=n,browser.tabs.detectLanguage(t).then(e=>{e&&"und"!==e&&(n.language=getPrimaryLanguageCode(e))}).catch(e=>{console.error("Error detecting language",e)}),BackgroundApp._updateBadge(t,n),BackgroundApp._updateUninstallURL(getHostNameFromUrl(e.tab.url))}static _onExtensionStatusChangedMessage(e,a){const t=a.tabId||e.tab.id;if(!BackgroundApp._extensionStates.hasOwnProperty(t))return;const n=BackgroundApp._extensionStates[t];"enabled"in a&&(n.enabled=a.enabled),"capitalization"in a&&(n.capitalization=a.capitalization),BackgroundApp._updateBadge(t,n)}static _onTrackTextLengthMessage(e,a){Tracker.trackTextLength(a.textLength)}static _onTrackEventMessage(e,a){Tracker.trackEvent("Action",a.action,a.label)}static _onShowTurnOnHintMessage(e,a){browser.tabs.sendMessage(e.tab.id,a,{frameId:0})}static _onOpenFeedbackForm(e,a){let t=`/feedbackForm/feedbackForm.html?url=${encodeURIComponent(a.url.substr(0,200))}`;a.html&&(t+=`&html=${encodeURIComponent(a.html.substr(0,400))}`),a.title&&(t+=`&title=${encodeURIComponent(a.title)}`),browser.windows.create({url:browser.runtime.getURL(t),type:"popup",width:375,height:500}).then(e=>{e&&e.id&&browser.windows.update(e.id,{left:Math.round((e.left||0)+(screen.availWidth-375)/2),top:Math.round((e.top||0)+(screen.availHeight-500)/2)})})}static _onSendFeedbackMessage(e,a){fetch("https://languagetoolplus.com/send-feedback/",{method:"POST",mode:"cors",body:JSON.stringify({sender:a.sender,text:a.text})}).catch(()=>{Tracker.trackError("http","error_send_feedback")})}static _onOpenOptionsMessage(e,a){let t="/options/options.html";a.ref&&(t+=`?ref=${encodeURIComponent(a.ref)}`),browser.tabs.create({url:browser.runtime.getURL(t)})}static _onOpenPrivacyConfirmationMessage(e,a){browser.tabs.create({url:config.INSTALL_URL})}static _onCloseCurrentTabMessage(e,a){browser.tabs.query({currentWindow:!0,active:!0}).then(e=>{e.length&&browser.tabs.remove(e[0].id)})}static _onValidateTextMessage(e,a){Tracker.trackActivity();const t=BackgroundApp._storageController.getUIState().hasPaidSubscription||BackgroundApp._storageController.isUsedCustomServer()?config.MAX_TEXT_LENGTH_PREMIUM:config.MAX_TEXT_LENGTH;if(a.text.length>=t){const e={command:"VALIDATION_FAILED",instanceId:a.metaData.instanceId,exception:{status:400,message:browser.i18n.getMessage("textTooLong"),response:"Text too long"}};return Promise.resolve(e)}if(0===BackgroundApp._validationsWithinOneSecond.count&&setTimeout(()=>{BackgroundApp._validationsWithinOneSecond.count=0},1e3),BackgroundApp._validationsWithinOneSecond.count++,BackgroundApp._validationsWithinOneSecond.count>6){const e={command:"VALIDATION_FAILED",instanceId:a.metaData.instanceId,exception:{status:0,message:"Too many requests in one second",response:"Too many requests in one second"}};return Promise.resolve(e)}const{geoIpLanguages:n,motherTongue:o}=BackgroundApp._storageController.getSettings(),r=getUserLanguageCodes().concat(n);if(e.tab){const a=BackgroundApp._extensionStates[e.tab.id];a&&a.language&&r.push(a.language)}o&&r.push(o),a.elementLanguage&&r.push(getPrimaryLanguageCode(a.elementLanguage)),-1===r.indexOf("en")&&r.push("en");const s=BackgroundApp._storageController.getStatistics().usageCount+1;return BackgroundApp._storageController.updateStatistics({usageCount:s}),BackgroundApp._updateUninstallURL(getHostNameFromUrl(a.metaData.url)),Promise.all([Validator.validate(a.text,a.forceLanguage?a.language:null,r,a.metaData,a.hasUserChangedLanguage),Validator.partialValidate(a.changedParagraphs,a.language,r,a.metaData,!a.forceLanguage)]).then(([e,t])=>{const n=e.language||a.language,o=n&&n.name===BackgroundApp.UNSUPPORTED_LANGUAGE_NAME;return o&&(n.code=r[0]),{command:"VALIDATION_COMPLETED",instanceId:a.metaData.instanceId,text:a.text,changedParagraphs:a.changedParagraphs,language:n,isUnsupportedLanguage:o,isIncompleteResult:t.isIncompleteResult,validationErrors:e.errors,validationHiddenErrors:e.hiddenErrors,partialValidationErrors:t.errors,partialValidationHiddenErrors:t.hiddenErrors}}).catch(e=>{if(!e||"AbortError"!==e.reason)return{command:"VALIDATION_FAILED",instanceId:a.metaData.instanceId,exception:{reason:e.reason,status:e.status,message:e.message,response:e.response,stack:e.stack}}})}static _onLaunchValidatorMessage(e,a){BackgroundApp._launchValidator(a.text)}static _onValidatorLoadedMessage(e,a){const t=BackgroundApp._validatorsData[a.id];return BackgroundApp._validatorsData[a.id]=null,Promise.resolve({text:t?t.text:""})}static _onValidateClicked(e,a){a?browser.tabs.sendMessage(a.id,{command:"GET_SELECTED_TEXT"}).then(e=>{BackgroundApp._launchValidator(e.selectedText)}).catch(a=>{BackgroundApp._launchValidator(e.selectionText)}):BackgroundApp._launchValidator(e.selectionText),BackgroundApp._storageController.updateUIState({hasUsedValidator:!0})}}BackgroundApp.UNSUPPORTED_LANGUAGE_NAME="NoopLanguage",BackgroundApp._extensionStates=new Map,BackgroundApp._validationsWithinOneSecond={count:0,tracked:!1},BackgroundApp._validatorsData=new Map,BackgroundApp._isInitialized=!1,BackgroundApp._constructor();