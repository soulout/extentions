/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class LTAssistant{constructor(e){if(BrowserDetector.isUnsupportedChrome()||BrowserDetector.isUnsupportedFirefox()||!document.documentElement||"HTML"!==document.documentElement.nodeName)return;this._options=e,this._instances=[],this._otherSpellCheckers=new Map,this._behaviorTweaks=TweaksManager.getTweaks(getCurrentUrl()),this._behaviorTweaks.init();const t=this._behaviorTweaks.supported(),r=this._behaviorTweaks.unsupportedMessage();if(this._onMessage=bindAndCatch(this._onMessage,this),!t)return browser.runtime.sendMessage({command:"PAGE_LOADED",enabled:!0,capitalization:!0,supported:t,unsupportedMessage:r}),void browser.runtime.onMessage.addListener(this._onMessage);this._validateInstanceDebounce=new Debounce(bindAndCatch(this._validateInstance,this),config.VALIDATION_DEBOUNCE_TIMEOUT),this._onDocumentClick=bindAndCatch(this._onDocumentClick,this),this._onDocumentFocus=bindAndCatch(this._onDocumentFocus,this),this._onTextChanged=bindAndCatch(this._onTextChanged,this),this._onInputScroll=bindAndCatch(this._onInputScroll,this),this._onBlockClicked=bindAndCatch(this._onBlockClicked,this),this._onPermissionRequiredIconClicked=bindAndCatch(this._onPermissionRequiredIconClicked,this),this._onToggleDialog=bindAndCatch(this._onToggleDialog,this),this._onPremiumIconVisible=bindAndCatch(this._onPremiumIconVisible,this),this._onLanguageChanged=bindAndCatch(this._onLanguageChanged,this),this._enableHere=bindAndCatch(this._enableHere,this),this._enableEverywhere=bindAndCatch(this._enableEverywhere,this),this._onErrorSelected=bindAndCatch(this._onErrorSelected,this),this._onTurnOffClicked=bindAndCatch(this._onTurnOffClicked,this),this._onOptionsOpen=bindAndCatch(this._onOptionsOpen,this),this._onAddToDictionaryClicked=bindAndCatch(this._onAddToDictionaryClicked,this),this._onDialogDestroyed=bindAndCatch(this._onDialogDestroyed,this),this._onFixSelected=bindAndCatch(this._onFixSelected,this),this._onIgnoreRuleClicked=bindAndCatch(this._onIgnoreRuleClicked,this),this._onTemporarilyIgnoreRule=bindAndCatch(this._onTemporarilyIgnoreRule,this),this._onTemporarilyIgnoreWord=bindAndCatch(this._onTemporarilyIgnoreWord,this),this._onErrorCardDestroyed=bindAndCatch(this._onErrorCardDestroyed,this),this._onSettingsChanged=bindAndCatch(this._onSettingsChanged,this),this._onUiStateChanged=bindAndCatch(this._onUiStateChanged,this),this._onShowFeedbackForm=bindAndCatch(this._onShowFeedbackForm,this),this._onPrivacySettingsChanged=bindAndCatch(this._onPrivacySettingsChanged,this),this._onDestroy=bindAndCatch(this.destroy,this),this._onMoreDetailsClicked=bindAndCatch(this._onMoreDetailsClicked,this),this._onBadgeClicked=bindAndCatch(this._onBadgeClicked,this),this._onLogoClicked=bindAndCatch(this._onLogoClicked,this),this._onPageHide=bindAndCatch(this._onPageHide,this),this._sendPageLoaded=bindAndCatch(this._sendPageLoaded,this),this._checkExtensionHealthInterval=window.setInterval(bindAndCatch(this._checkExtensionHealth,this),config.CHECK_EXTENSION_HEALTH_INTERVAL),document.addEventListener(LTAssistant.eventNames.destroy,this._onDestroy),window.addEventListener("pageshow",this._sendPageLoaded),window.addEventListener("pagehide",this._onPageHide),this._storageController=new StorageController(bindAndCatch(()=>{this._sendPageLoaded();const e=document.querySelector(":focus");e&&this._initInstance(e,!0),window._ltLastActiveElement&&(this._initInstance(window._ltLastActiveElement,!1),window._ltLastActiveElement=null),browser.runtime.onMessage.addListener(this._onMessage),document.addEventListener("click",this._onDocumentClick,!0),document.addEventListener("focus",this._onDocumentFocus,!0),window.frameElement&&window.frameElement.ownerDocument&&window.frameElement.ownerDocument.addEventListener("click",this._onDocumentClick,!0),document.addEventListener(InputAreaWrapper.eventNames.textChanged,this._onTextChanged),document.addEventListener(InputAreaWrapper.eventNames.scroll,this._onInputScroll),document.addEventListener(Highlighter.eventNames.blockClicked,this._onBlockClicked),document.addEventListener(Toolbar.eventNames.permissionRequiredIconClicked,this._onPermissionRequiredIconClicked),document.addEventListener(Toolbar.eventNames.toggleDialog,this._onToggleDialog),document.addEventListener(Toolbar.eventNames.notifyAboutPremiumIcon,this._onPremiumIconVisible),document.addEventListener(Dialog.eventNames.changeLanguage,this._onLanguageChanged),document.addEventListener(Dialog.eventNames.enableHere,this._enableHere),document.addEventListener(Dialog.eventNames.enableEverywhere,this._enableEverywhere),document.addEventListener(Dialog.eventNames.errorSelected,this._onErrorSelected),document.addEventListener(Dialog.eventNames.fixSelected,this._onFixSelected),document.addEventListener(Dialog.eventNames.turnOff,this._onTurnOffClicked),document.addEventListener(Dialog.eventNames.addToDictionaryClicked,this._onAddToDictionaryClicked),document.addEventListener(Dialog.eventNames.ignoreRuleClicked,this._onIgnoreRuleClicked),document.addEventListener(Dialog.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.addEventListener(Dialog.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.addEventListener(Dialog.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.addEventListener(Dialog.eventNames.openOptions,this._onOptionsOpen),document.addEventListener(Dialog.eventNames.showFeedbackForm,this._onShowFeedbackForm),document.addEventListener(Dialog.eventNames.destroyed,this._onDialogDestroyed),document.addEventListener(ErrorCard.eventNames.fixSelected,this._onFixSelected),document.addEventListener(ErrorCard.eventNames.addToDictionaryClicked,this._onAddToDictionaryClicked),document.addEventListener(ErrorCard.eventNames.ignoreRuleClicked,this._onIgnoreRuleClicked),document.addEventListener(ErrorCard.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.addEventListener(ErrorCard.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.addEventListener(ErrorCard.eventNames.destroyed,this._onErrorCardDestroyed),document.addEventListener(ErrorCard.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.addEventListener(ErrorCard.eventNames.badgeClicked,this._onBadgeClicked),document.addEventListener(ErrorCard.eventNames.logoClicked,this._onLogoClicked),this._storageController.addEventListener(StorageController.eventNames.settingsChanged,this._onSettingsChanged),this._storageController.addEventListener(StorageController.eventNames.privacySettingsChanged,this._onPrivacySettingsChanged),this._storageController.addEventListener(StorageController.eventNames.uiStateChanged,this._onUiStateChanged)},this))}static _isStartWithUppercase(e){const t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()}static"_toLowerсaseFirstChar"(e){return e.charAt(0).toLowerCase()+e.substr(1)}static _isErrorIgnoredByDictionary(e,t){if(!e.isSpellingError)return!1;let r=e.misspelledWord;if(/^\w+\.$/.test(r)&&(r=r.substring(0,r.length-1)),t.includes(r))return!0;if(LTAssistant._isStartWithUppercase(r)){const e=LTAssistant._toLowerсaseFirstChar(r);if(t.includes(e))return!0}return!1}static _isErrorRuleIgnored(e,t){const r=getPrimaryLanguageCode(e.language.code);return!!t.find(t=>t.id===e.rule.id&&("*"===t.language||t.language===r))}static _getTextChanges(e,t,r){const n=getParagraphsDiff(e,t),i=[];for(const e of r){const t=Object.assign({},e),r=t.offset,s=t.offset+t.length;let o=!0;for(const e of n)if(null!==e.oldText){const n=e.oldOffset,i=e.oldOffset+e.oldText.length+1;if(isIntersect(r,s,n,i)){if(null!==e.textDiff){const n=e.oldOffset+e.textDiff.from,i=n+e.textDiff.oldFragment.length;if(isIntersect(r,s,n,i,!0)){o=!1;break}if(r>i){const r=e.textDiff.newFragment.length-e.textDiff.oldFragment.length;t.offset+=r}}t.offset+=e.newOffset-e.oldOffset}}o&&i.push(t)}const s=n.filter(e=>e.oldText!==e.newText&&null!==e.newText).map(e=>({text:e.newText,offset:e.newOffset}));return{changedParagraphs:s,nonAffectedErrors:i,isAllTextChanged:s.map(e=>e.text).join("\n")===t}}static _getRemainedErrors(e,t){const r=[];for(const n of e){const e=Object.assign({},n),i=e.offset,s=e.offset+e.length;let o=!0;for(const e of t){const t=e.offset,r=e.offset+e.text.length+1;if(isIntersect(i,s,t,r)){o=!1;break}}o&&r.push(Object.assign({},e))}return r}_getDomainState(){const e=getMainPageHostname();return this._storageController.getValidationSettings(e)}_sendPageLoaded(){const e=this._behaviorTweaks.supported(),t=this._behaviorTweaks.unsupportedMessage(),r=this._getDomainState();browser.runtime.sendMessage({command:"PAGE_LOADED",enabled:!r.isDisabled,capitalization:r.shouldCapitalizationBeChecked,supported:e,unsupportedMessage:t})}_setDisplayedErrors(e,t){const r=e.displayedErrors;if(e.pendingErrors=[],e.displayedErrors=[],0===t.length)return;const{dictionary:n,ignoredRules:i}=this._storageController.getSettings(),s=e.validatedText,o=e.inputAreaWrapper.getSelection();t.forEach(t=>{if(!(LTAssistant._isErrorIgnoredByDictionary(t,n)||LTAssistant._isErrorIgnoredByDictionary(t,e.ignoredWords)||LTAssistant._isErrorRuleIgnored(t,i)||LTAssistant._isErrorRuleIgnored(t,e.ignoredRules))){if(e.isTyping){const n=!r.some(e=>e.offset===t.offset);if(n&&t.contextForSureMatch){const r=s.substr(t.offset+t.length,100),n=!!r.match(LTAssistant.PUNCTUATION_REG_EXP)||!!t.originalPhrase.match(LTAssistant.PUNCTIUATION_CHAR_REG_EXP);if(-1===t.contextForSureMatch&&!n)return void e.pendingErrors.push(t);if(!n){if(r.split(/\s+/).length-1<t.contextForSureMatch)return void e.pendingErrors.push(t)}}const i=o&&(o.start===t.offset||o.end===t.offset+t.length);if(n&&i)return void e.pendingErrors.push(t)}e.displayedErrors.push(t)}})}_setHiddenErrors(e,t){const r=e.displayedHiddenErrors;if(e.pendingHiddenErrors=[],e.displayedHiddenErrors=[],0===t.length)return;const n=e.validatedText,i=e.inputAreaWrapper.getSelection();t.forEach(t=>{if(e.isTyping){const s=!r.some(e=>e.offset===t.offset);if(s&&t.contextForSureMatch){const r=n.substr(t.offset+t.length,100),i=!!r.match(LTAssistant.PUNCTUATION_REG_EXP)||!!t.originalPhrase.match(LTAssistant.PUNCTIUATION_CHAR_REG_EXP);if(-1===t.contextForSureMatch&&!i)return void e.pendingHiddenErrors.push(t);if(!i){if(r.split(/\s+/).length-1<t.contextForSureMatch)return void e.pendingHiddenErrors.push(t)}}const o=i&&(i.start===t.offset||i.end===t.offset+t.length);if(s&&o)return void e.pendingHiddenErrors.push(t)}e.displayedHiddenErrors.push(t)})}_getIgnoredErrorsStats(e){const{dictionary:t,ignoredRules:r}=this._storageController.getSettings(),n=[],i=[];return e.forEach(e=>{e.isSpellingError&&LTAssistant._isErrorIgnoredByDictionary(e,t)&&!n.includes(e.misspelledWord)&&n.push(e.misspelledWord),e.isSpellingError||!LTAssistant._isErrorRuleIgnored(e,r)||i.includes(e.rule.id)||i.push(e.rule.id)}),{byDictionary:n.length,byRules:i.length}}_initInstance(e,t=!0){e.parentElement&&(this._instances.some(t=>t.targetElement===e)||this._getDomainState().isDisabled||this._behaviorTweaks.isElementCompatible(e)&&(this._disableOtherSpellCheckers(e),clearTimeout(this._initTimeout),this._initTimeout=window.setTimeout(()=>{if(t&&!e.matches(":focus"))return void this._enableOtherSpellCheckers(e);const r=Math.round(99999*Math.random())+":"+Date.now(),n=isTextArea(e)?new Mirror(e):null,i=new InputAreaWrapper(e,n?n.getCloneElement():e,this._behaviorTweaks.getParsingDetector(e)),s=new Highlighter(e,i,n?n.getCloneElement():e,this._behaviorTweaks.getHighlighterAppearance(e),!!n),o=new Toolbar(e,this._behaviorTweaks.getToolbarAppearance(e),n),a={id:r,group:location.pathname,targetElement:e,mirror:n,inputAreaWrapper:i,highlighter:s,toolbar:o,errorCard:null,dialog:null,requestStatus:REQUEST_STATUS.COMPLETED,isRemoteCheckAllowed:this._storageController.getPrivacySettings().allowRemoteCheck,isAutoCheckEnabled:this._getDomainState().isAutoCheckEnabled,isConnected:!0,isTyping:!1,isValidating:!1,isIncompleteResult:!1,isTextTooLong:!1,exception:null,language:null,forceLanguage:!1,isSupportedLanguage:!0,lastValidation:0,validatedText:"",allErrors:[],displayedErrors:[],pendingErrors:[],allHiddenErrors:[],displayedHiddenErrors:[],displayedHiddenErrorCount:0,pendingHiddenErrors:[],selectedErrorId:null,temporaryDisabledErrorId:null,ignoredRules:[],ignoredWords:[],tracking:{sawPremiumIcon:!1,hasEnoughText:!1,language:null,hasTracked:!1,textLength:0}};this._instances.push(a),this.updateState(a),this._validateInstance(a),onElementDisabled(e,()=>this._destroyInstance(a)),onElementRemoved(e,()=>this._destroyInstance(a))},150)))}_validateInstance(e,t,r,n=!1){if(!e.isRemoteCheckAllowed||!e.isAutoCheckEnabled)return;if(-1===this._instances.indexOf(e))return;void 0===t&&(t=e.inputAreaWrapper.getText(),r=LTAssistant._getTextChanges(e.validatedText,t,e.allErrors)),e.isTextTooLong=!1,e.exception=null;const{hasPaidSubscription:i}=this._storageController.getUIState();if(!i&&!this._storageController.isUsedCustomServer()&&t.length>config.MAX_TEXT_LENGTH)return e.isValidating=!1,e.isTextTooLong=!0,e.allErrors=[],e.allHiddenErrors=[],this._setDisplayedErrors(e,e.allErrors),this._setHiddenErrors(e,e.allHiddenErrors),this._leaveTypingMode(e),this._highlight(e),this.updateState(e),void(e.validatedText="");e.isValidating=!0,e.lastValidation=Date.now(),e.isSupportedLanguage||(e.isSupportedLanguage=!0,e.forceLanguage||(e.language=null)),this.updateState(e),!e.forceLanguage&&r.isAllTextChanged&&(e.language=null),this._behaviorTweaks.getRecipientInfo(e.targetElement).then(i=>{const s={instanceId:e.id,url:getCurrentUrl(),recipientInfo:i},o={command:"VALIDATE_TEXT",text:t,changedParagraphs:r.changedParagraphs,language:e.language,forceLanguage:e.forceLanguage,userLanguageCodes:getUserLanguageCodes(),elementLanguage:e.targetElement.lang,hasUserChangedLanguage:n,metaData:s};browser.runtime.sendMessage(o).then(e=>{e&&"VALIDATION_COMPLETED"===e.command?this._onValidationCompleted(e):e&&"VALIDATION_FAILED"===e.command&&this._onValidationFailed(e)}).catch(t=>{e.isValidating=!1,Tracker.trackError("message",t.message,o.command),(t.message&&t.message.startsWith("Invocation of form runtime.connect(null, ) doesn't match definition runtime.connect")||t.message.startsWith("Extension context invalidated."))&&this._instances.forEach(e=>{e.isConnected=!1,e.highlighter&&e.highlighter.destroy()}),this.updateState(e)})})}_revalidateInstance(e,t,r=!1){e.language=t,e.forceLanguage=r,e.validatedText="",e.allErrors=[],e.displayedErrors=[],e.allHiddenErrors=[],e.displayedHiddenErrors=[],this._highlight(e),this._hideAllErrorCards(),this._validateInstance(e,void 0,void 0,r)}_destroyInstance(e){const t=this._instances.indexOf(e);-1!==t&&(t>-1&&this._instances.splice(t,1),e.inputAreaWrapper.destroy(),e.highlighter.destroy(),e.toolbar.destroy(),clearTimeout(e.typingTimeout),e.mirror&&e.mirror.destroy(),e.errorCard&&e.errorCard.destroy(),e.dialog&&e.dialog.destroy(),this._enableOtherSpellCheckers(e.targetElement),this._savePremiumErrorCount(e),this._trackInstance(e))}updateState(e,t=""){let r=REQUEST_STATUS.COMPLETED,n="";e.isConnected?e.isValidating||e.isTyping?r=REQUEST_STATUS.IN_PROGRESS:e.exception?(r=REQUEST_STATUS.FAILED,n=e.exception.message):e.isTextTooLong?r=REQUEST_STATUS.TEXT_TOO_LONG:e.isSupportedLanguage?e.isAutoCheckEnabled?e.isRemoteCheckAllowed?e.validatedText.length<config.MIN_TEXT_LENGTH&&(r=REQUEST_STATUS.TEXT_TOO_SHORT):r=REQUEST_STATUS.PERMISSION_REQUIRED:r=REQUEST_STATUS.DISABLED:r=REQUEST_STATUS.UNSUPPORTED_LANGUAGE:r=REQUEST_STATUS.DISCONNECTED,e.requestStatus=r;const i={requestStatus:r,errorsCount:e.displayedErrors.length,hiddenErrorsCount:e.displayedHiddenErrors.length,isIncompleteResult:e.isIncompleteResult,languageName:t,exceptionMessage:n};if(e.toolbar.updateState(i),e.dialog){const i={requestStatus:r,languageName:t,errors:e.displayedErrors,hiddenErrors:e.displayedHiddenErrors,ignoredErrorsStats:this._getIgnoredErrorsStats(e.allErrors),isIncompleteResult:e.isIncompleteResult,exceptionMessage:n};e.dialog.updateState(i)}e.displayedHiddenErrorCount=Math.max(e.displayedHiddenErrorCount,e.displayedHiddenErrors.length),dispatchCustomEvent(LTAssistant.eventNames.updateState,{requestStatus:r,exceptionMessage:n,languageName:t,errors:e.displayedErrors,hiddenErrors:e.displayedHiddenErrors,isIncompleteResult:e.isIncompleteResult})}_highlight(e){const t=e.displayedErrors.map(t=>{let r=config.COLORS.GRAMMAR.UNDERLINE,n=config.COLORS.GRAMMAR.BACKGROUND;return t.isSpellingError?(r=config.COLORS.SPELLING.UNDERLINE,n=config.COLORS.SPELLING.BACKGROUND):t.isStyleError&&(r=config.COLORS.STYLE.UNDERLINE,n=config.COLORS.STYLE.BACKGROUND),{id:t.id,offset:t.offset,length:t.length,isEmphasized:t.id===e.selectedErrorId,backgroundColor:n,isUnderlined:!0,underlineColor:r}});e.highlighter.highlight(t)}_showErrorCard(e,t,r){this._hideAllErrorCards(),e.errorCard=new ErrorCard(r,t,e.targetElement,this._storageController.getUIState().hasPaidSubscription)}_hideAllErrorCards(){this._instances.forEach(e=>{e.errorCard&&e.errorCard.destroy()})}_showDialog(e){this._hideAllErrorCards(),this._hideAllDialogs(),e.dialog=new Dialog(e.toolbar.getContainer(),e.language&&e.language.code,{requestStatus:e.requestStatus,errors:e.displayedErrors,hiddenErrors:e.displayedHiddenErrors,ignoredErrorsStats:this._getIgnoredErrorsStats(e.allErrors),isIncompleteResult:e.isIncompleteResult,exceptionMessage:e.exception&&e.exception.message||""},this._storageController.getUIState())}_hideAllDialogs(){this._instances.forEach(e=>{e.dialog&&e.dialog.destroy()})}_showTurnOnHint(){if(window.parent!==window)browser.runtime.sendMessage({command:"SHOW_TURN_ON_HINT"});else{const e=document.createElement("lt-hint"),t=document.createElement("lt-div");t.classList.add("lt-hint__wrapper");const r=document.createElement("lt-div");r.classList.add("lt-hint__message"),r.textContent=browser.i18n.getMessage("turnOnHint");const n=document.createElement("lt-div");n.classList.add("lt-hint__arrow"),t.appendChild(r),t.appendChild(n),e.appendChild(t),(document.body.isContentEditable?document.documentElement:document.body).appendChild(e),setAnimationFrameTimeout(()=>{fadeOutAndRemove(e)},5e3)}}_enableHere(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);t&&(t.isAutoCheckEnabled=!0,this._revalidateInstance(t,t.language),Tracker.trackEvent("Action","check_trigger:manually_triggered"))}_enableEverywhere(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);t&&(t.isAutoCheckEnabled=!0,this._revalidateInstance(t,t.language),this._storageController.updateSettings({autoCheck:!0,ignoreCheckOnDomains:[]}),Tracker.trackEvent("Action","enable_everywhere"))}_onTextChanged(e){const t=e.detail.inputAreaWrapper,r=this._instances.find(e=>e.inputAreaWrapper===t);if(!r)return;if(!r.isConnected||!r.isRemoteCheckAllowed||!r.isAutoCheckEnabled)return;this._hideAllErrorCards(),this._enterTypingMode(r);const n=e.detail.text;if(r.exception=null,n.trim().length<config.MIN_TEXT_LENGTH)r.language=r.forceLanguage?r.language:null,r.isValidating=!1,r.isTextTooLong=!1,r.allErrors=[],r.allHiddenErrors=[],this._setDisplayedErrors(r,r.allErrors),this._setHiddenErrors(r,r.allHiddenErrors),this._leaveTypingMode(r),this._highlight(r),this.updateState(r),r.validatedText=n,this._validateInstanceDebounce.cancelCall();else if(n===r.validatedText)r.isValidating=!1,this._setDisplayedErrors(r,r.allErrors),this._setHiddenErrors(r,r.allHiddenErrors),this._highlight(r),this.updateState(r),this._validateInstanceDebounce.cancelCall();else{const e=LTAssistant._getTextChanges(r.validatedText,n,r.allErrors);r.isValidating=!0,r.isTextTooLong=!1,this._setDisplayedErrors(r,e.nonAffectedErrors),this._setHiddenErrors(r,r.allHiddenErrors),this._highlight(r),this.updateState(r),Date.now()-r.lastValidation>config.INTERMEDIATE_VALIDATION_INTERVAL?(this._validateInstanceDebounce.cancelCall(),this._validateInstance(r,n,e)):this._validateInstanceDebounce.call(r,n,e)}}_enterTypingMode(e){e.isTyping=!0,clearTimeout(e.typingTimeout),e.typingTimeout=window.setTimeout(()=>{this._leaveTypingMode(e),this._setDisplayedErrors(e,e.allErrors),this._setHiddenErrors(e,e.allHiddenErrors),this._highlight(e),this.updateState(e,e.language&&e.language.code||"")},config.STOPPED_TYPING_TIMEOUT)}_leaveTypingMode(e){e.isTyping=!1,clearTimeout(e.typingTimeout)}_onInputScroll(){window.requestAnimationFrame(()=>this._hideAllErrorCards())}_onMessage(e){switch(e.command){case"GET_SELECTED_TEXT":{const e=getSelectedText();if(e)return Promise.resolve({selectedText:e});break}case"SHOW_TURN_ON_HINT":this._showTurnOnHint()}return!1}_onUnsupportedLanguage(e,t){e.isSupportedLanguage=!1,e.isIncompleteResult=!1,e.validatedText=t.text,e.allErrors=[],e.allHiddenErrors=[],this._setDisplayedErrors(e,e.allErrors),this._setHiddenErrors(e,e.allHiddenErrors),e.selectedErrorId=null,e.language=t.language,e.forceLanguage=!1,e.errorCard&&e.errorCard.destroy(),e.dialog&&(e.dialog.destroy(),e.dialog=null),this._highlight(e),this.updateState(e,t.language.code)}_onValidationCompleted(e){const t=this._instances.find(t=>t.id===e.instanceId);if(t)if(t.isValidating=!1,e.isUnsupportedLanguage)this._onUnsupportedLanguage(t,e);else if(e.language&&!t.language&&(t.language=e.language),e.text.length>config.MIN_TEXT_LENGTH&&(t.tracking.language=e.language?e.language.code:null,t.tracking.hasEnoughText=!0),t.tracking.textLength=Math.max(e.text.length,t.tracking.textLength),t.dialog&&e.language&&t.dialog.setCurrentLanguage(e.language.code),t.forceLanguage||!e.language||e.language.code.toLowerCase()===t.language.code.toLowerCase()){let r=t.allErrors.slice(0),n=t.allHiddenErrors.slice(0);r=r.filter(e=>e.isPartialValidation),n=n.filter(e=>e.isPartialValidation);let i=LTAssistant._getTextChanges(t.validatedText,e.text,r),s=LTAssistant._getTextChanges(t.validatedText,e.text,n);r=LTAssistant._getRemainedErrors(i.nonAffectedErrors,i.changedParagraphs),n=LTAssistant._getRemainedErrors(s.nonAffectedErrors,s.changedParagraphs),r=r.concat(e.partialValidationErrors),n=n.concat(e.partialValidationHiddenErrors);for(const t of e.validationErrors)r.some(e=>e.offset===t.offset&&e.length===t.length)||r.push(t);for(const t of e.validationHiddenErrors)n.some(e=>e.offset===t.offset&&e.length===t.length)||n.push(t);r.sort((e,t)=>e.offset>t.offset?1:-1);for(let e=0;e<r.length;e++)r[e].id=e+1;n.sort((e,t)=>e.offset>t.offset?1:-1);for(let e=0;e<n.length;e++)n[e].id=e+1;const o=t.inputAreaWrapper.getText();i=LTAssistant._getTextChanges(e.text,o,r),s=LTAssistant._getTextChanges(e.text,o,n),t.validatedText=e.text,t.allErrors=r,t.allHiddenErrors=n,t.isIncompleteResult=e.isIncompleteResult,this._setDisplayedErrors(t,i.nonAffectedErrors),this._setHiddenErrors(t,s.nonAffectedErrors),t.pendingErrors.length||t.pendingHiddenErrors.length||this._leaveTypingMode(t),this._highlight(t),this.updateState(t)}else this._revalidateInstance(t,e.language)}_onValidationFailed(e){const t=this._instances.find(t=>t.id===e.instanceId);if(t){if(t.isValidating=!1,t.isIncompleteResult=!1,t.exception=e.exception,t.validatedText="",t.allErrors=[],t.displayedErrors=[],t.pendingErrors=[],t.allHiddenErrors=[],t.displayedHiddenErrors=[],t.pendingHiddenErrors=[],e&&e.exception&&void 0!==e.exception.status)this._storageController.isUsedCustomServer()||Tracker.trackError("http",`${e.exception.status}: ${e.exception.response}`);else if(e&&e.exception&&e.exception.message){const r=e.exception;t.exception={message:browser.i18n.getMessage("statusIconError")};const n=generateStackTrace(r);Tracker.trackError("js",r.message,n||"")}else Tracker.trackError("http","unknown");this._highlight(t),this.updateState(t)}}_onDocumentFocus(e){e.target instanceof HTMLElement&&this._initInstance(e.target)}_onDocumentClick(e){if(this._behaviorTweaks.isClickIgnored(e))return;closestElement(e.target,ErrorCard.CONTAINER_ELEMENT_NAME)||this._hideAllErrorCards(),closestElement(e.target,`${Dialog.CONTAINER_ELEMENT_NAME}, ${Toolbar.CONTAINER_ELEMENT_NAME}`)||this._hideAllDialogs()}_disableOtherSpellCheckers(e){if(this._otherSpellCheckers.get(e))return;const t={spellcheck:e.getAttribute("spellcheck"),"data-gramm":e.getAttribute("data-gramm")};e.setAttribute("spellcheck","false"),e.setAttribute("data-gramm","false");const r=new MutationObserver(()=>{"false"===e.getAttribute("spellcheck")&&"false"===e.getAttribute("data-gramm")||(e.setAttribute("spellcheck","false"),e.setAttribute("data-gramm","false"))});r.observe(e,{attributes:!0,attributeFilter:["spellcheck","data-gramm"]}),this._otherSpellCheckers.set(e,{originalAttributes:t,mutationObserver:r})}_enableOtherSpellCheckers(e){const t=this._otherSpellCheckers.get(e);if(t){t.mutationObserver.disconnect();for(const r in t.originalAttributes){const n=t.originalAttributes[r];t.originalAttributes[r]?e.setAttribute(r,n):e.removeAttribute(r)}this._otherSpellCheckers.delete(e)}}_onBlockClicked(e){const t=this._instances.find(t=>t.highlighter===e.detail.highlighter);if(this._hideAllErrorCards(),this._hideAllDialogs(),t){const r=t.displayedErrors.find(t=>t.id===e.detail.blockId);if(!r)return;if(t.temporaryDisabledErrorId===r.id)return;if(getSelectedText().trim())return;this._showErrorCard(t,e.detail.clickedRectangle,r),t.selectedErrorId=r.id,this._highlight(t)}}_onErrorSelected(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);if(t){t.selectedErrorId=e.detail.errorId,this._highlight(t);const r=t.displayedErrors.find(e=>e.id===t.selectedErrorId);r&&t.inputAreaWrapper.scrollToText(r.offset,r.length)}}_onFixSelected(e){let t;if("errorCard"in e.detail){const r=e.detail.errorCard;t=this._instances.find(e=>e.errorCard===r)}else if("dialog"in e.detail){const r=e.detail.dialog;t=this._instances.find(e=>e.dialog===r)}if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,n={error:r,replacementText:r.fixes[e.detail.fixIndex].value,instance:t};this._behaviorTweaks.applyFix(n),this._validateInstanceDebounce.callAfter(100);const{appliedSuggestions:i}=this._storageController.getStatistics();this._storageController.updateStatistics({appliedSuggestions:i+1}),Tracker.trackEvent("Action","check_trigger:apply_suggestion",String(e.detail.fixIndex))}_onTurnOffClicked(e){const t=getMainPageHostname();this._storageController.disableDomain(t),browser.runtime.sendMessage({command:"EXTENSION_STATUS_CHANGED",enabled:!1}),this._showTurnOnHint()}_onAddToDictionaryClicked(e){const t=this._instances.find(t=>"errorCard"in e.detail&&e.detail.errorCard===t.errorCard||"dialog"in e.detail&&e.detail.dialog===t.dialog);this._hideAllErrorCards();const r=e.detail.error,n=this._storageController.getSettings().dictionary;n.push(r.misspelledWord),this._storageController.updateSettings({dictionary:n});const i=t&&t.language?getPrimaryLanguageCode(t.language.code):"unknown";Tracker.trackEvent("Action","check_trigger:add_to_dict",`${i}: ${r.misspelledWord}`)}_onIgnoreRuleClicked(e){this._hideAllErrorCards();const t=e.detail.error,r=this._storageController.getSettings().ignoredRules,n={id:t.rule.id,language:getPrimaryLanguageCode(t.language.code),description:t.rule.description};r.push(n),this._storageController.updateSettings({ignoredRules:r});let i="check_trigger:turn_off_rule";t.rule.isPremium&&(i+=":premium"),Tracker.trackEvent("Action",i,n.id)}_onTemporarilyIgnoreWord(e){const t=this._instances.find(t=>"errorCard"in e.detail&&t.errorCard===e.detail.errorCard||"dialog"in e.detail&&t.dialog===e.detail.dialog);if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,n=t.group;this._instances.filter(e=>e.group===n).forEach(e=>{e.ignoredWords.push(r.misspelledWord),this._setDisplayedErrors(e,e.allErrors),this._highlight(e),this.updateState(e,e.language&&e.language.code||"")}),Tracker.trackEvent("Action","check_trigger:temp_ignore_word",r.originalPhrase)}_onTemporarilyIgnoreRule(e){const t=this._instances.find(t=>"errorCard"in e.detail&&t.errorCard===e.detail.errorCard||"dialog"in e.detail&&t.dialog===e.detail.dialog);if(this._hideAllErrorCards(),!t)return;const r=e.detail.error,n=t.group;this._instances.filter(e=>e.group===n).forEach(e=>{e.ignoredRules.push({id:r.rule.id,language:getPrimaryLanguageCode(r.language.code),description:r.rule.description}),this._setDisplayedErrors(e,e.allErrors),this._highlight(e),this.updateState(e,e.language&&e.language.code||"")});let i="check_trigger:temp_ignore_rule";r.rule.isPremium&&(i+=":premium"),Tracker.trackEvent("Action",i,r.rule.id)}_onShowFeedbackForm(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);if(!t)return;const r=t.targetElement.cloneNode(!1);try{r.innerText=`${t.inputAreaWrapper.getText().length} chars, ${t.language?t.language.code:"unknown lang"}`}catch(e){}browser.runtime.sendMessage({command:"OPEN_FEEDBACK_FORM",url:getCurrentUrl(),html:r.outerHTML||""})}_onMoreDetailsClicked(e){window.open(e.detail.url,"_blank"),Tracker.trackEvent("Action","show_rule_details",e.detail.url)}_onBadgeClicked(e){browser.runtime.sendMessage({command:"OPEN_OPTIONS",ref:"errorcard"}),this._hideAllErrorCards(),Tracker.trackEvent("Action","check_trigger:badge:clicked",String(`premium:${this._storageController.getUIState().hasPaidSubscription}`))}_onLogoClicked(e){window.open("https://languagetoolplus.com/?pk_campaign=addon2-errorcard-logo","_blank"),this._hideAllErrorCards(),Tracker.trackEvent("Action","check_trigger:logo:clicked",String(`premium:${this._storageController.getUIState().hasPaidSubscription}`))}_onToggleDialog(e){const t=this._instances.find(t=>t.toolbar===e.detail.toolbar);if(!t)return;const r=!t.dialog;this._hideAllDialogs(),r&&this._showDialog(t)}_onPremiumIconVisible(e){const t=this._instances.find(t=>t.toolbar===e.detail.toolbar);t&&t.language&&(t.tracking.sawPremiumIcon=!0)}_onErrorCardDestroyed(e){const t=this._instances.find(t=>t.errorCard===e.detail.errorCard);t&&(t.errorCard=null,t.selectedErrorId===e.detail.error.id&&(t.temporaryDisabledErrorId=t.selectedErrorId,setTimeout(()=>t.temporaryDisabledErrorId=null,500),t.selectedErrorId=null,this._highlight(t)))}_onDialogDestroyed(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);t&&(t.dialog=null,null===t.errorCard&&null!==t.selectedErrorId&&(t.selectedErrorId=null,this._highlight(t)))}_onLanguageChanged(e){const t=this._instances.find(t=>t.dialog===e.detail.dialog);if(!t)return;const r=t.language;if(t.language=e.detail.language,this._revalidateInstance(t,e.detail.language,!0),r&&r.code){if(Tracker.trackEvent("Action","check_trigger:switch_language",`${r.code} -> ${e.detail.language.code}`),r.code.indexOf("-")>-1&&e.detail.language.code.indexOf("-")>-1){const t=r.code.split(/-(.+)/),n=e.detail.language.code.split(/-(.+)/),i=t[0],s=t[1],o=n[0],a=n[1];if(i===o&&s!==a){const t=e.detail.language.code.split(/-/),r=2===t.length?t[0]+"-"+t[1].toUpperCase():t[0]+"-"+t[1].toUpperCase()+"-"+t.splice(2);"en"===o?this._storageController.updateSettings({enVariant:r}):"de"===o?this._storageController.updateSettings({deVariant:r}):"pt"===o?this._storageController.updateSettings({ptVariant:r}):"ca"===o&&this._storageController.updateSettings({caVariant:r})}}}else Tracker.trackEvent("Action","check_trigger:switch_language",`unknown -> ${e.detail.language.code}`)}_onOptionsOpen(e){browser.runtime.sendMessage({command:"OPEN_OPTIONS",ref:e.detail.ref})}_onSettingsChanged(e){if(e.dictionary||e.ignoredRules)for(const e of this._instances)this._setDisplayedErrors(e,e.allErrors),this._highlight(e),this.updateState(e,e.language&&e.language.code||"");if(e.disabledDomains||e.autoCheck||e.ignoreCheckOnDomains||e.autoCheckOnDomains){const e=this._getDomainState(),t=Array.prototype.slice.call(this._instances);for(const r of t)if(e.isDisabled)this._destroyInstance(r);else if(e.isAutoCheckEnabled){!r.isAutoCheckEnabled&&(r.isAutoCheckEnabled=!0,this._revalidateInstance(r,r.language))}else e.isAutoCheckEnabled?e.shouldCapitalizationBeChecked||this._revalidateInstance(r,r.language):(r.isAutoCheckEnabled=!1,r.allErrors=[],r.displayedErrors=[],r.pendingErrors=[],r.allHiddenErrors=[],r.displayedHiddenErrors=[],r.pendingHiddenErrors=[],this._highlight(r),this.updateState(r),this._hideAllErrorCards(),this._hideAllDialogs())}e.disabledDomainsCapitalization&&this._instances.forEach(e=>{this._revalidateInstance(e,e.language)})}_onUiStateChanged(e){if(e.hasPaidSubscription)for(const e of this._instances)this._revalidateInstance(e,e.language)}_onPermissionRequiredIconClicked(){window.open(config.INSTALL_URL),Tracker.trackEvent("Action","toolbar:open_install_url")}_onPrivacySettingsChanged(e){e.allowRemoteCheck&&e.allowRemoteCheck.newValue&&this._instances.forEach(e=>{e.isRemoteCheckAllowed=!0,this._validateInstance(e)})}_checkExtensionHealth(){isRuntimeConnected()||(this._instances.forEach(e=>{e.isConnected=!1,e.highlighter&&e.highlighter.destroy(),this.updateState(e)}),clearInterval(this._checkExtensionHealthInterval))}_trackInstance(e){(isRuntimeConnected()||e.tracking.hasTracked)&&(e.tracking.hasTracked=!0,e.tracking.hasEnoughText&&browser.runtime.sendMessage({command:"TRACK_EVENT",action:`saw_premium_icon:${e.tracking.sawPremiumIcon}`,label:e.tracking.language}),Math.random()<.1&&browser.runtime.sendMessage({command:"TRACK_TEXT_LENGTH",textLength:e.tracking.textLength}))}_savePremiumErrorCount(e){if(!e.displayedHiddenErrorCount||!isRuntimeConnected())return;const t=(new Date).toDateString(),{hiddenErrors:r}=this._storageController.getStatistics();r[0]&&r[0].day===t?r[0].count+=e.displayedHiddenErrorCount:r.unshift({day:t,count:e.displayedHiddenErrorCount}),r.length=Math.min(r.length,62),this._storageController.updateStatistics({hiddenErrors:r})}_onPageHide(){this._instances.forEach(e=>{this._savePremiumErrorCount(e),this._trackInstance(e)})}destroy(){this._instances.slice(0).forEach(e=>this._destroyInstance(e));try{browser.runtime.onMessage.removeListener(this._onMessage)}catch(e){}document.removeEventListener("click",this._onDocumentClick,!0),document.removeEventListener("focus",this._onDocumentFocus,!0),window.frameElement&&window.frameElement.ownerDocument&&window.frameElement.ownerDocument.removeEventListener("click",this._onDocumentClick,!0),document.removeEventListener(InputAreaWrapper.eventNames.textChanged,this._onTextChanged),document.removeEventListener(InputAreaWrapper.eventNames.scroll,this._onInputScroll),document.removeEventListener(Highlighter.eventNames.blockClicked,this._onBlockClicked),document.removeEventListener(Toolbar.eventNames.permissionRequiredIconClicked,this._onPermissionRequiredIconClicked),document.removeEventListener(Toolbar.eventNames.toggleDialog,this._onToggleDialog),document.removeEventListener(Toolbar.eventNames.notifyAboutPremiumIcon,this._onPremiumIconVisible),document.removeEventListener(Dialog.eventNames.changeLanguage,this._onLanguageChanged),document.removeEventListener(Dialog.eventNames.enableHere,this._enableHere),document.removeEventListener(Dialog.eventNames.enableEverywhere,this._enableEverywhere),document.removeEventListener(Dialog.eventNames.errorSelected,this._onErrorSelected),document.removeEventListener(Dialog.eventNames.fixSelected,this._onFixSelected),document.removeEventListener(Dialog.eventNames.turnOff,this._onTurnOffClicked),document.removeEventListener(Dialog.eventNames.addToDictionaryClicked,this._onAddToDictionaryClicked),document.removeEventListener(Dialog.eventNames.ignoreRuleClicked,this._onIgnoreRuleClicked),document.removeEventListener(Dialog.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.removeEventListener(Dialog.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.removeEventListener(Dialog.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.removeEventListener(Dialog.eventNames.openOptions,this._onOptionsOpen),document.removeEventListener(Dialog.eventNames.showFeedbackForm,this._onShowFeedbackForm),document.removeEventListener(Dialog.eventNames.destroyed,this._onDialogDestroyed),document.removeEventListener(ErrorCard.eventNames.fixSelected,this._onFixSelected),document.removeEventListener(ErrorCard.eventNames.addToDictionaryClicked,this._onAddToDictionaryClicked),document.removeEventListener(ErrorCard.eventNames.ignoreRuleClicked,this._onIgnoreRuleClicked),document.removeEventListener(ErrorCard.eventNames.temporarilyIgnoreWordClicked,this._onTemporarilyIgnoreWord),document.removeEventListener(ErrorCard.eventNames.temporarilyIgnoreRuleClicked,this._onTemporarilyIgnoreRule),document.removeEventListener(ErrorCard.eventNames.destroyed,this._onErrorCardDestroyed),document.removeEventListener(ErrorCard.eventNames.moreDetailsClicked,this._onMoreDetailsClicked),document.removeEventListener(ErrorCard.eventNames.badgeClicked,this._onBadgeClicked),document.removeEventListener(ErrorCard.eventNames.logoClicked,this._onLogoClicked),window.removeEventListener("pageshow",this._sendPageLoaded),window.removeEventListener("pagehide",this._onPageHide),this._storageController&&this._storageController.destroy(),clearTimeout(this._initTimeout),clearInterval(this._checkExtensionHealthInterval),this._validateInstanceDebounce&&this._validateInstanceDebounce.cancelCall(),document.documentElement&&document.documentElement.removeAttribute("data-lt-installed"),this._options.onDestroy&&this._options.onDestroy()}}LTAssistant.eventNames={destroy:"_lt-destroy",updateState:"_lt-update-state"},LTAssistant.PUNCTUATION_REG_EXP=/^[^\n]*?[.!?]($|\s)/,LTAssistant.PUNCTIUATION_CHAR_REG_EXP=/^[.!?]$/;