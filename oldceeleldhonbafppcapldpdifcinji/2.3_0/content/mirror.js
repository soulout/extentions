/*! (C) Copyright 2018 LanguageTooler GmbH. All rights reserved. */
class Mirror{constructor(e){this._textArea=e,this._domMeasurement=new DomMeasurement(this._textArea.ownerDocument),this._render=bindAndCatch(this._render,this),this._updateText=bindAndCatch(this._updateText,this),this._onTextAreaScroll=bindAndCatch(this._onTextAreaScroll,this),this._onTextAreaClick=bindAndCatch(this._onTextAreaClick,this),this._render(),this._textArea.addEventListener("scroll",this._onTextAreaScroll),this._textArea.addEventListener("click",this._onTextAreaClick),this._textArea.addEventListener("input",this._updateText),window.ResizeObserver&&(this._textAreaResizeObserver=new window.ResizeObserver(this._render),this._textAreaResizeObserver.observe(this._textArea)),this._renderInterval=setAnimationFrameInterval(this._render,config.RENDER_INTERVAL)}static getElementByPos(e,t,i){const r=new DOMWalker(e);let n=null;do{const e=r.node();if(isElementNode(e)){getBorderBoxes(e).some(e=>isPointInsideBox(e,t,i))&&(n=e)}}while(r.next());return n}_dispatchClick(e,t){const i=new MouseEvent(Mirror.eventNames.click,{view:window,screenX:t.screenX,screenY:t.screenY,clientX:t.clientX,clientY:t.clientY,button:t.button,buttons:t.buttons,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,bubbles:!0,cancelable:!0});e.dispatchEvent(i)}_dispatchInput(){const e=new Event(Mirror.eventNames.input,{bubbles:!0,cancelable:!0});this.getCloneElement().dispatchEvent(e)}_render(){if(!this._textArea.parentElement)return;this._domMeasurement.clearCache();const e=this._domMeasurement.getBorderBox(this._textArea,!1),t=this._domMeasurement.getContentBox(this._textArea);this._container||(this._container=document.createElement(Mirror.CONTAINER_ELEMENT_NAME),this._wrapper=document.createElement("lt-div"),this._wrapper.setAttribute("spellcheck","false"),this._wrapper.className="lt-mirror__wrapper",this._canvas=document.createElement("lt-div"),this._canvas.className="lt-mirror__canvas",this._wrapper.appendChild(this._canvas),this._container.appendChild(this._wrapper),this._inlineTextAreaLineHeight=this._domMeasurement.getInlineStyle(this._textArea,"line-height"),this._computedTextAreaLineHeight=this._domMeasurement.getStyle(this._textArea,"line-height")),this._textArea.style.lineHeight===this._computedTextAreaLineHeight?this._domMeasurement.setStyles(this._textArea,{"line-height":this._inlineTextAreaLineHeight}):this._inlineTextAreaLineHeight=this._domMeasurement.getInlineStyle(this._textArea,"lineHeight"),this._computedTextAreaLineHeight=this._domMeasurement.getStyle(this._textArea,"line-height"),this._computedTextAreaLineHeight.includes("px")&&this._domMeasurement.setStyles(this._textArea,{"line-height":this._computedTextAreaLineHeight});this._domMeasurement.copyStyles(this._textArea,this._wrapper,["border","border-radius","border-top-width","border-right-width","border-left-width","border-bottom-width","border-top-style","border-right-style","border-left-style","border-bottom-style","direction","font","font-family","font-feature-settings","font-kerning","font-language-override","font-size","font-size-adjust","font-stretch","font-style","font-synthesis","font-variant","font-variant-caps","font-variant-east-asian","font-variant-ligatures","font-variant-numeric","font-weight","hyphens","letter-spacing","line-break","line-height","margin","margin-top","margin-left","margin-bottom","margin-right","padding","padding-top","padding-left","padding-right","padding-bottom","text-align","text-decoration","text-indent","text-transform","word-spacing","word-wrap"],!0),this._updateText(),this._textArea.previousElementSibling!==this._container&&this._textArea.parentElement.insertBefore(this._container,this._textArea),this._domMeasurement.setStyles(this._wrapper,{width:t.width+"px",height:t.height+"px"},!0);const i=this._domMeasurement.getBorderBox(this._wrapper,!1),r=e.left-i.left;if(Math.abs(r)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-left"));e+=r,this._domMeasurement.setStyles(this._wrapper,{"margin-left":e+"px"},!0)}const n=e.top-i.top;if(Math.abs(n)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-top"));e+=n,this._domMeasurement.setStyles(this._wrapper,{"margin-top":e+"px"},!0)}const s=this._domMeasurement.getScrollDimensions(this._textArea);let a=s.width-t.padding.left-t.padding.right,o=s.height-t.padding.top-t.padding.bottom;a===Math.round(t.width)&&(a=t.width),this._domMeasurement.setStyles(this._canvas,{width:a+"px",height:o+"px"},!0),this._updateScrolling(!1)}_updateScrolling(e=!0){e&&this._domMeasurement.clearCache();const t=this._domMeasurement.getScrollPosition(this._textArea);this._domMeasurement.setStyles(this._canvas,{"margin-top":-t.top+"px","margin-left":-t.left+"px"},!0),this._wrapper.dataset.ltScrollTop=t.top.toString(),this._wrapper.dataset.ltScrollLeft=t.left.toString()}_updateText(){const e=this._textArea.value;this._currentText!==e&&(this._currentText=e,this._canvas.textContent=e,this._updateScrolling(),this._dispatchInput())}_onTextAreaScroll(){window.requestAnimationFrame(()=>{this._updateScrolling()})}_onTextAreaClick(e){if(void 0===e.clientX||void 0===e.clientY)return;const t=Mirror.getElementByPos(this.getCloneElement(),e.clientX,e.clientY);t&&this._dispatchClick(t,e)}getCloneElement(){return this._wrapper}enableRangeMeasurements(){this._wrapper.classList.add("lt-mirror-enable-range-measurement")}disableRangeMeasurements(){this._wrapper.classList.remove("lt-mirror-enable-range-measurement")}destroy(){this._textArea.removeEventListener("input",this._updateText),this._textArea.removeEventListener("scroll",this._onTextAreaScroll),this._textArea.removeEventListener("click",this._onTextAreaClick),this._renderInterval&&this._renderInterval.destroy(),this._container&&this._container.remove(),this._textAreaResizeObserver&&this._textAreaResizeObserver.disconnect(),this._domMeasurement.clearCache()}}Mirror.CONTAINER_ELEMENT_NAME="lt-mirror",Mirror.eventNames={input:"lt-mirror-input",click:"lt-mirror-click"};